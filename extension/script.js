const e={g:{action:'https://www.google.com/search',param:'q',color:'#4285F4'},b:{action:'https://www.baidu.com/s',param:'wd',color:'#2932E1'},bi:{action:'https://www.bing.com/search',param:'q',color:'#00809d'},gh:{action:'https://github.com/search',param:'q',color:'#A371F7'},v:{action:'https://search.bilibili.com/all',param:'keyword',color:'#FB7299'},z:{action:'https://www.zhihu.com/search',param:'q',color:'#0084FF'},y:{action:'https://www.youtube.com/results',param:'search_query',color:'#FF0000'}},i=document.getElementById('q'),f=document.getElementById('search-form'),c=document.querySelector('.idle-caret'),m=document.getElementById('measure'),g=document.getElementById('ghost'),w=document.querySelector('.input-wrapper'),G=15,lh=()=>{try{return(JSON.parse(sessionStorage.getItem('searchHistory'))||[]).map(t=>"string"==typeof t?t.trim():"").filter(Boolean).filter((t,e,r)=>0===e||r[e-1]!==t)}catch{return[]}};let h=lh(),hi=-1,ti='',cr=null,bt=null,jt=null;
const ss=()=>{const t=window.getComputedStyle(i);m.style.font=t.font,m.style.letterSpacing=t.letterSpacing,m.style.fontVariantLigatures=t.fontVariantLigatures,m.style.lineHeight=t.lineHeight},uu=()=>{const t=i.value;m.textContent=t;const e=m.getBoundingClientRect().width,r=w.clientWidth,n=t.length?G:0,o=e+n-i.scrollLeft,a=Math.max(0,Math.min(o,r-18));c.style.transform=`translate(${a}px, -50%) scale(1.3, 0.85)`,null!==cr?(g.textContent=`= ${cr}`,g.style.transform=`translate(${a+25}px, -50%)`):g.textContent="",c.classList.remove("blink"),c.style.opacity=1,clearTimeout(jt),jt=setTimeout(()=>{c.style.transform=`translate(${a}px, -50%) scale(1, 1)`},100),clearTimeout(bt),bt=setTimeout(()=>{c.classList.add("blink")},500)},tk=t=>{const e=[];let r="";const n=()=>{if(r){if(!/^\d*\.?\d+$/.test(r)&&!/^\d+\.$/.test(r))return!1;e.push(r),r=""}return!0};for(const o of t)/\d/.test(o)||'.'===o?('.'===o&&r.includes('.')||(r+=o)):/\s/.test(o)?n()||0:'+-*/()'.includes(o)?n()&&(e.push(o),1):0;return n()&&e.length?e:null},tr=t=>{const e=[],r=[],n={"+":1,"-":1,"*":2,"/":2};let o=null;for(const a of t){if(!isNaN(parseFloat(a))){e.push(parseFloat(a)),o="num";continue}if("("===a){r.push(a),o="(";continue}if(")"===a){for(;r.length&&"("!==r[r.length-1];)e.push(r.pop());if("("!==r.pop())return null;o=")";continue}if("+-*/".includes(a)){if(("-"===a||"+"===a)&&(null===o||"("===o||"op"===o)){if("-"===a&&e.push(0),"+"===a)continue}else{if("op"===o)return null;if(null===o)return null}for(;r.length;){const t=r[r.length-1];if("("===t||n[t]<n[a])break;e.push(r.pop())}r.push(a),o="op";continue}return null}for(;r.length;){const t=r.pop();if("("===t)return null;e.push(t)}return e},er=t=>{const e=[];for(const r of t){if("number"==typeof r){e.push(r);continue}const n=e.pop(),o=e.pop();if(void 0===o||void 0===n)return null;switch(r){case"+":e.push(o+n);break;case"-":e.push(o-n);break;case"*":e.push(o*n);break;case"/":e.push(0===n?NaN:o/n);break;default:return null}}return 1===e.length&&isFinite(e[0])?e[0]:null},tc=t=>{if(!t||t.endsWith(" "))return null;const r=t.trim();if(!/[+\-*/]/.test(r))return null;const n=tk(r);if(!n)return null;const o=tr(n);if(!o)return null;const a=er(o);if(null===a)return null;const s=(l=a,p=12,parseFloat(l.toPrecision(p)));var l,p;const u=(d=s,Number.isInteger(d)?d:parseFloat(d.toFixed(10)));var d;return String(u)===r?null:u},se=(t,r,n=!0)=>{f.action=t.action,i.name=t.param,document.body.style.setProperty("--flash-color",t.color),i.value="",i.scrollLeft=0,n&&r&&localStorage.setItem("defaultSearchEngine",r),c.style.transition="none",g.style.transition="none",uu(),void c.offsetWidth,c.classList.remove("blink"),c.classList.remove("flash-brand"),void c.offsetWidth,c.classList.add("flash-brand"),setTimeout(()=>{c.classList.remove("flash-brand"),c.style.transition="transform 0.1s cubic-bezier(0.25, 1.5, 0.5, 1), background-color 0.2s, opacity 0.5s ease",g.style.transition="transform 0.1s cubic-bezier(0.25, 1.5, 0.5, 1)",c.classList.add("blink")},500)},tt=(t,e=!0)=>{const r="dark"===t;r?(document.body.classList.add("dark"),document.body.classList.remove("light-forced")):(document.body.classList.remove("dark"),document.body.classList.add("light-forced")),e&&localStorage.setItem("theme",t),setTimeout(uu,50)},ts=()=>{w.classList.remove("shake"),void w.offsetWidth,w.classList.add("shake")},trc=()=>{w.classList.remove("recoil"),void w.offsetWidth,w.classList.add("recoil"),setTimeout(()=>w.classList.remove("recoil"),50)},iu=t=>{const e=t.trim();if(!e||/\s/.test(e))return!1;const r=e.match(/^([a-z][a-z0-9+.-]*):\/\//i);if(r){const t=r[1].toLowerCase();return new Set(["http","https","ftp","ftps"]).has(t)&&!new Set(["javascript","data","vbscript","file"]).has(t)}try{const t=new URL(e).protocol.replace(":","").toLowerCase();return new Set(["http","https","ftp","ftps"]).has(t)&&!new Set(["javascript","data","vbscript","file"]).has(t)}catch{}const n=e.split("/"),o=n[0],a=/^(localhost|\d{1,3}(?:\.\d{1,3}){3}|[a-z0-9-]+(?:\.[a-z0-9-]+)+)(?::\d{2,5})?$/i;return!!a.test(o)&&(!n.slice(1).length||!/\s/.test(n.slice(1).join("/")))};i.addEventListener("input",()=>{cr=tc(i.value),hi=-1,trc(),uu()}),i.addEventListener("keydown",r=>{if(" "===r.key){const n=i.value;if(n.startsWith("/")){const o=n.slice(1).toLowerCase();if(e[o])return r.preventDefault(),void se(e[o],o);if("dark"===o)return r.preventDefault(),void tt("dark");if("light"===o)return r.preventDefault(),void tt("light")}}if("Escape"===r.key)return i.value="",hi=-1,void uu();if("Tab"===r.key&&null!==cr&&(r.preventDefault(),i.value=cr,cr=null,uu()),"ArrowUp"===r.key&&(r.preventDefault(),h.length&&(-1===hi&&(ti=i.value),hi=Math.min(hi+1,h.length-1),i.value=h[h.length-1-hi],uu())),"ArrowDown"===r.key&&(r.preventDefault(),hi>-1&&(hi--,i.value=-1===hi?ti:h[h.length-1-hi],uu())),"Enter"===r.key){const n=i.value.trim();n.startsWith("/")&&!n.includes(" ")&&(r.preventDefault(),ts())}}),f.addEventListener("submit",t=>{const r=i.value.trim();if(!r)return void t.preventDefault();if(r.startsWith("/")&&!r.includes(" "))return t.preventDefault(),void ts();h[h.length-1]!==r&&(h.push(r),h.length>50&&h.shift(),sessionStorage.setItem("searchHistory",JSON.stringify(h))),t.preventDefault(),document.body.classList.add("departing"),setTimeout(()=>{if(iu(r))window.location.href=r.startsWith("http")?r:"http://"+r;else{const t=i.name,n=f.action;window.location.href=`${n}?${t}=${encodeURIComponent(r)}`}},300)}),window.addEventListener("pageshow",()=>{document.body.classList.remove("departing"),c.classList.add("blink")}),window.addEventListener("resize",()=>{ss(),uu()}),i.addEventListener("scroll",uu),i.addEventListener("focus",uu),document.body.addEventListener("click",()=>i.focus()),w.addEventListener("animationend",()=>w.classList.remove("shake"));const se_ls=localStorage.getItem("defaultSearchEngine");se_ls&&e[se_ls]&&(f.action=e[se_ls].action,i.name=e[se_ls].param);const st=localStorage.getItem("theme");st&&tt(st,!1);setTimeout(()=>{ss(),uu()},10);
